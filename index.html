<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analyseur Débit & pH</title>
  <meta name="description" content="Analyse, filtre par période, synthèses et récap des écarts (débit & pH)" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX + FileSaver -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {50:'#f0f9ff',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8'},
            warning: {50:'#fefce8',200:'#fde047',500:'#eab308'},
            danger: {50:'#fef2f2',200:'#fecaca',500:'#ef4444'}
          }
        }
      }
    }
  </script>

  <style>
    .upload-zone{border:2px dashed #d1d5db;transition:all .3s ease}
    .upload-zone:hover{border-color:#3b82f6;background:#f8fafc}
    .upload-zone.dragover{border-color:#2563eb;background:#eff6ff}
    .table-header{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    .alert-row{background:#fef2f2!important;border-left:4px solid #ef4444}
    .warning-row{background:#fefce8!important;border-left:4px solid #eab308}
    .nav-tab{transition:all .3s ease}
    .nav-tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;transform:translateY(-2px);box-shadow:0 4px 8px rgba(59,130,246,.3)}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">📊 Analyseur Débit & pH</h1>
      <p class="text-gray-600 text-lg">Filtre par période, synthèses & récap des écarts</p>
    </header>

    <main class="max-w-7xl mx-auto">
      <!-- Upload -->
      <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">📁 Importation des fichiers</h2>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Débit -->
          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-3">💧 Fichier Débit (dernière valeur/jour)</h3>
            <div id="uploadZoneDebit" class="upload-zone rounded-lg p-6 text-center cursor-pointer">
              <div class="mb-3">
                <svg class="mx-auto h-10 w-10 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.413V13H5.5z"/>
                </svg>
              </div>
              <p class="text-sm text-gray-600">Déposez le fichier débit ici</p>
              <p class="text-xs text-gray-400 mt-1">Seuil d'alerte: &gt; 220</p>
            </div>
            <input type="file" id="fileInputDebit" accept=".xlsx,.xls,.csv" class="hidden">
            <div id="fileInfoDebit" class="mt-3 hidden">
              <div class="flex items-center p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                <span id="fileNameDebit" class="text-blue-800 font-medium"></span>
                <span id="fileSizeDebit" class="text-blue-600 ml-2"></span>
              </div>
            </div>
          </div>

          <!-- pH -->
          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-3">🧪 Fichier pH (moyenne/jour)</h3>
            <div id="uploadZonePh" class="upload-zone rounded-lg p-6 text-center cursor-pointer">
              <div class="mb-3">
                <svg class="mx-auto h-10 w-10 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.413V13H5.5z"/>
                </svg>
              </div>
              <p class="text-sm text-gray-600">Déposez le fichier pH ici</p>
              <p class="text-xs text-gray-400 mt-1">Seuil d'alerte: 5.5 - 8.5</p>
            </div>
            <input type="file" id="fileInputPh" accept=".xlsx,.xls,.csv" class="hidden">
            <div id="fileInfoPh" class="mt-3 hidden">
              <div class="flex items-center p-2 bg-green-50 border border-green-200 rounded-lg text-sm">
                <span id="fileNamePh" class="text-green-800 font-medium"></span>
                <span id="fileSizePh" class="text-green-600 ml-2"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtres -->
        <div class="mt-8 grid sm:grid-cols-[1fr_1fr_auto_auto] gap-3 items-end">
          <div>
            <label for="startDate" class="block text-sm text-gray-600 mb-1">Du</label>
            <input id="startDate" type="date" class="w-full border rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label for="endDate" class="block text-sm text-gray-600 mb-1">Au</label>
            <input id="endDate" type="date" class="w-full border rounded-lg px-3 py-2"/>
          </div>
          <button id="applyFilterBtn" class="bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-lg font-medium transition-colors" disabled>Appliquer</button>
          <button id="resetFilterBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-medium transition-colors" disabled>Réinitialiser</button>
        </div>
        <p id="activeRange" class="text-sm text-gray-600 mt-2 hidden">Période filtrée : <span class="font-medium"></span></p>

        <div class="mt-6 text-center">
          <button id="analyzeBtn" class="bg-primary-500 hover:bg-primary-600 text-white py-3 px-8 rounded-lg font-medium transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>🔍 Analyser les données</button>
        </div>
      </section>

      <!-- Résultats -->
      <section id="resultsSection" class="hidden">
        <div class="bg-white rounded-t-lg shadow-lg">
          <div class="flex border-b border-gray-200">
            <button class="nav-tab active px-6 py-3 font-medium rounded-tl-lg" data-tab="daily">📅 Données journalières</button>
            <button class="nav-tab px-6 py-3 font-medium" data-tab="synthesis">📈 Synthèses</button>
            <button class="nav-tab px-6 py-3 font-medium" data-tab="alerts">⚠️ Récap alertes</button>
          </div>
        </div>

        <div class="bg-white rounded-b-lg shadow-lg">
          <!-- Daily -->
          <div id="dailyTab" class="tab-content p-6">
            <div class="flex flex-wrap gap-3 justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">📊 Données journalières</h2>
              <div class="flex flex-wrap gap-2">
                <button id="exportDailyBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">📥 CSV (journalier)</button>
                <button id="exportExcelBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">📥 Excel formaté (couleurs + récap)</button>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-semibold text-blue-600 mb-3">💧 Débit (dernière valeur/jour)</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="table-header text-white">
                      <tr><th class="px-4 py-2 text-xs font-medium uppercase">Date</th><th class="px-4 py-2 text-xs font-medium uppercase">Valeur</th><th class="px-4 py-2 text-xs font-medium uppercase">État</th></tr>
                    </thead>
                    <tbody id="debitTable" class="divide-y divide-gray-200"></tbody>
                  </table>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-green-600 mb-3">🧪 pH (moyenne/jour)</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="table-header text-white">
                      <tr><th class="px-4 py-2 text-xs font-medium uppercase">Date</th><th class="px-4 py-2 text-xs font-medium uppercase">Moyenne</th><th class="px-4 py-2 text-xs font-medium uppercase">État</th></tr>
                    </thead>
                    <tbody id="phTable" class="divide-y divide-gray-200"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Synthèses -->
          <div id="synthesisTab" class="tab-content p-6 hidden">
            <div class="flex flex-wrap gap-3 justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">📈 Synthèses</h2>
              <div class="flex gap-2">
                <button id="exportSynthesisBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">📥 CSV (synthèses)</button>
                <button id="exportRecapBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium">📥 CSV (récap écarts)</button>
              </div>
            </div>
            <div class="space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">📊 Synthèse mensuelle</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="table-header text-white">
                      <tr><th class="px-4 py-2 text-xs font-medium uppercase">Mois</th><th class="px-4 py-2 text-xs font-medium uppercase">Débit Moy.</th><th class="px-4 py-2 text-xs font-medium uppercase">pH Moy.</th><th class="px-4 py-2 text-xs font-medium uppercase">Alertes Débit</th><th class="px-4 py-2 text-xs font-medium uppercase">Alertes pH</th></tr>
                    </thead>
                    <tbody id="monthlyTable" class="divide-y divide-gray-200"></tbody>
                  </table>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">📈 Synthèse annuelle</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="table-header text-white">
                      <tr><th class="px-4 py-2 text-xs font-medium uppercase">Année</th><th class="px-4 py-2 text-xs font-medium uppercase">Débit Moy.</th><th class="px-4 py-2 text-xs font-medium uppercase">pH Moy.</th><th class="px-4 py-2 text-xs font-medium uppercase">Alertes Débit</th><th class="px-4 py-2 text-xs font-medium uppercase">Alertes pH</th></tr>
                    </thead>
                    <tbody id="yearlyTable" class="divide-y divide-gray-200"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Alertes -->
          <div id="alertsTab" class="tab-content p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">⚠️ Récapitulatif des alertes</h2>
            <div id="alertsSummary" class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
              <div class="bg-red-50 p-4 rounded-lg border border-red-200"><div class="text-2xl font-bold text-red-600" id="alertsDebitCount">0</div><div class="text-sm text-red-600">Alertes débit (&gt; 220)</div></div>
              <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><div class="text-2xl font-bold text-yellow-600" id="alertsPhCount">0</div><div class="text-sm text-yellow-600">Alertes pH (&lt; 5.5 ou &gt; 8.5)</div></div>
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><div class="text-2xl font-bold text-gray-600" id="totalAlertsCount">0</div><div class="text-sm text-gray-600">Total alertes</div></div>
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"><div class="text-2xl font-bold text-blue-600" id="worstDeviation">—</div><div class="text-sm text-blue-600">Écart max (absolu)</div></div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="table-header text-white">
                  <tr><th class="px-4 py-2 text-xs font-medium uppercase">Date</th><th class="px-4 py-2 text-xs font-medium uppercase">Type</th><th class="px-4 py-2 text-xs font-medium uppercase">Valeur</th><th class="px-4 py-2 text-xs font-medium uppercase">Seuil</th><th class="px-4 py-2 text-xs font-medium uppercase">Écart</th></tr>
                </thead>
                <tbody id="alertsTable" class="divide-y divide-gray-200"></tbody>
              </table>
            </div>
            <div class="mt-4">
              <button id="exportAlertsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">📥 CSV (alertes)</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    window.addEventListener('load', function() {
      // --- État ---
      let debitData = [];
      let phData = [];
      let processedData = { daily:{debit:[],ph:[]}, monthly:[], yearly:[], alerts:[] };
      let filteredData  = { daily:{debit:[],ph:[]}, monthly:[], yearly:[], alerts:[] };

      // bornes de filtre stockées en millisecondes UTC
      let startMs = null;
      let endMs   = null;

      const DEBIT_THRESHOLD = 220;
      const PH_MIN = 5.5;
      const PH_MAX = 8.5;

      // DOM
      const analyzeBtn = document.getElementById('analyzeBtn');
      const resultsSection = document.getElementById('resultsSection');
      const startDateInput = document.getElementById('startDate');
      const endDateInput   = document.getElementById('endDate');
      const applyFilterBtn = document.getElementById('applyFilterBtn');
      const resetFilterBtn = document.getElementById('resetFilterBtn');
      const activeRange    = document.getElementById('activeRange');

      // Onglets
      document.querySelectorAll('.nav-tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          const target = tab.dataset.tab;
          document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
          document.getElementById(target+'Tab').classList.remove('hidden');
        });
      });

      // Uploads
      setupFileUpload('Debit', (data)=>{ debitData=data; checkReady(); });
      setupFileUpload('Ph',    (data)=>{ phData=data;   checkReady(); });

      function checkReady(){
        const ready = debitData.length && phData.length;
        analyzeBtn.disabled     = !ready;
        applyFilterBtn.disabled = !ready;
        resetFilterBtn.disabled = !ready;
      }

      // Analyse & initialisation plage
      analyzeBtn.addEventListener('click', ()=>{
        if (!debitData.length || !phData.length) { alert('Les deux fichiers sont requis.'); return; }
        processedData.daily.debit = processDebitData(debitData);
        processedData.daily.ph    = processPhData(phData);

        // bornes par défaut = min/max (en UTC)
        const allUTC = Array.from(new Set([
          ...processedData.daily.debit.map(d=>d.date),
          ...processedData.daily.ph.map(d=>d.date)
        ])).map(dmy=>dmyStrToUTCms(dmy)).filter(Boolean).sort((a,b)=>a-b);

        if (allUTC.length){
          startDateInput.value = toInputUTC(allUTC[0]);
          endDateInput.value   = toInputUTC(allUTC[allUTC.length-1]);
        }

        applyFilter(); // applique la plage visible
        resultsSection.classList.remove('hidden');
      });

      // Filtre UI
      applyFilterBtn.addEventListener('click', ()=>applyFilter());
      resetFilterBtn.addEventListener('click', ()=>resetFilter());
      startDateInput.addEventListener('change', ()=>applyFilter());
      endDateInput.addEventListener('change', ()=>applyFilter());

      // ---------------- Upload helper ----------------
      function setupFileUpload(type, callback){
        const uploadZone = document.getElementById(`uploadZone${type}`);
        const fileInput  = document.getElementById(`fileInput${type}`);
        const fileInfo   = document.getElementById(`fileInfo${type}`);
        const fileNameEl = document.getElementById(`fileName${type}`);
        const fileSizeEl = document.getElementById(`fileSize${type}`);

        uploadZone.addEventListener('click', ()=>fileInput.click());
        uploadZone.addEventListener('dragover', e=>{ e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', ()=>uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e=>{
          e.preventDefault(); uploadZone.classList.remove('dragover');
          if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e=>{
          if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file){
          fileNameEl.textContent = file.name;
          fileSizeEl.textContent = `(${(file.size/1024/1024).toFixed(2)} MB)`;
          fileInfo.classList.remove('hidden');

          const reader = new FileReader();
          reader.onload = (ev)=>{
            try{
              let data;
              if (file.name.toLowerCase().endsWith('.csv')) {
                const csv = ev.target.result;
                const lines = csv.split(/\r?\n/).filter(l=>l.trim().length>0);
                const sep = detectSep(lines[0]);
                data = lines.map(line => line.split(sep).map(c=>c.trim()));
              } else {
                const wb = XLSX.read(ev.target.result, { type:'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                data = XLSX.utils.sheet_to_json(ws, { header:1 });
              }
              const clean = (data||[]).filter(r=>r && r.length>1 && r[0] && r[1]);
              callback(clean);
            }catch(err){
              console.error(err);
              alert(`Erreur lors du traitement du fichier ${type}`);
            }
          };
          if (file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file);
          else reader.readAsArrayBuffer(file);
        }
      }

      function detectSep(headerLine){
        const sc = (headerLine.match(/;/g)||[]).length;
        const cc = (headerLine.match(/,/g)||[]).length;
        return sc >= cc ? ';' : ',';
      }

      // ---------------- DATES — parsing & comparaisons en UTC ----------------
      function toInputUTC(ms){
        const d = new Date(ms);
        const y = d.getUTCFullYear(), m = String(d.getUTCMonth()+1).padStart(2,'0'), day = String(d.getUTCDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      function parseInputDateUTC(s){
        const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return null;
        return Date.UTC(+m[1], +m[2]-1, +m[3]);
      }
      function parseDMYtoUTC(s){
        const m = String(s||'').match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})$/);
        if(!m) return null;
        let y = +m[3]; if (y < 100) y += 2000;
        return Date.UTC(y, +m[2]-1, +m[1]);
      }
      function parseExcelSerialUTC(s){
        const txt = String(s||'').trim();
        if(!/^\d{1,5}(\.\d+)?$/.test(txt)) return null;
        const serial = Math.floor(+txt);
        const epoch = Date.UTC(1899,11,30);
        return epoch + serial*86400000;
      }
      function parseAnyToUTC(s){
        if (s===null || s===undefined || s==='') return null;
        return parseExcelSerialUTC(s) ?? parseDMYtoUTC(s) ?? parseInputDateUTC(s);
      }
      function dmyStrToUTCms(dmy){
        let t = parseDMYtoUTC(dmy);
        if (t !== null) return t;
        return parseAnyToUTC(dmy);
      }

      // ---------------- Journalier ----------------
      function parseDateLoose(dateStr){
        // accepte "dd/MM/yyyy [HH:mm:ss]" ou formats repris ci-dessus
        const utc = parseAnyToUTC(dateStr);
        if (utc !== null) return new Date(utc);
        const parts = String(dateStr).trim().split(' ');
        const [d,m,y] = parts[0].split('/');
        let H=0,M=0,S=0;
        if (parts[1]) [H,M,S] = parts[1].split(':').map(v=>parseInt(v||0,10));
        return new Date(Number(y), Number(m)-1, Number(d), H||0, M||0, S||0);
      }
      function formatDate(d){
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        return `${dd}/${mm}/${d.getFullYear()}`;
      }

      function processDebitData(data){
        const perDay = {};
        data.forEach((row,i)=>{
          if (i===0) return;
          const dateStr = String(row[0]).trim();
          const v = parseFloat(String(row[1]).replace(',','.'));
          if (!dateStr || isNaN(v)) return;
          const d = parseDateLoose(dateStr);
          const key = formatDate(d);
          (perDay[key] = perDay[key] || []).push({time:d, value:v});
        });
        return Object.keys(perDay)
          .sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b))
          .map(k=>{
            const arr = perDay[k].sort((a,b)=>a.time-b.time);
            const last = arr[arr.length-1].value;
            return { date:k, value:last, isAlert:last>DEBIT_THRESHOLD, count:arr.length };
          });
      }
      function processPhData(data){
        const perDay = {};
        data.forEach((row,i)=>{
          if (i===0) return;
          const dateStr = String(row[0]).trim();
          const v = parseFloat(String(row[1]).replace(',','.'));
          if (!dateStr || isNaN(v)) return;
          const d = parseDateLoose(dateStr);
          const key = formatDate(d);
          (perDay[key] = perDay[key] || []).push(v);
        });
        return Object.keys(perDay)
          .sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b))
          .map(k=>{
            const arr = perDay[k];
            const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
            return { date:k, value:avg, isAlert:avg<PH_MIN || avg>PH_MAX, count:arr.length };
          });
      }

      // ---------------- Filtrage centralisé (UTC) ----------------
      function readRangeFromInputsUTC(){
        const s = (startDateInput.valueAsDate)
          ? Date.UTC(startDateInput.valueAsDate.getFullYear(), startDateInput.valueAsDate.getMonth(), startDateInput.valueAsDate.getDate())
          : parseInputDateUTC(startDateInput.value);
        const e = (endDateInput.valueAsDate)
          ? Date.UTC(endDateInput.valueAsDate.getFullYear(), endDateInput.valueAsDate.getMonth(), endDateInput.valueAsDate.getDate())
          : parseInputDateUTC(endDateInput.value);

        let a = s, b = e;
        if (a!=null && b!=null && a>b) { const t=a; a=b; b=t; }
        startMs = a;
        endMs   = b; // inclusif géré dans inRange()
      }
      function inRange(dateStrDMY){
        const t = dmyStrToUTCms(dateStrDMY);
        if (t==null) return false;
        const endInclusive = (endMs!=null) ? (endMs + 86400000 - 1) : null; // inclure toute la journée de fin
        if (startMs!=null && t < startMs) return false;
        if (endInclusive!=null && t > endInclusive) return false;
        return true;
      }
      function getAllDatesUTC(src){
        const set = new Set([...src.daily.debit.map(d=>d.date), ...src.daily.ph.map(d=>d.date)]);
        return Array.from(set).map(s=>dmyStrToUTCms(s)).filter(Boolean).sort((a,b)=>a-b);
      }

      function applyFilter(){
        if (!processedData.daily.debit.length && !processedData.daily.ph.length) return;

        readRangeFromInputsUTC();

        // sous-ensemble filtré
        filteredData.daily.debit = processedData.daily.debit.filter(d=>inRange(d.date));
        filteredData.daily.ph    = processedData.daily.ph   .filter(d=>inRange(d.date));

        // recalcul + rendu
        rebuildAllViews();

        // badge période
        if (startMs!=null && endMs!=null){
          activeRange.querySelector('span').textContent = `${toInputUTC(startMs)} → ${toInputUTC(endMs)}`;
          activeRange.classList.remove('hidden');
        } else {
          activeRange.classList.add('hidden');
        }
      }

      function resetFilter(){
        const all = getAllDatesUTC(processedData);
        if (all.length){
          startMs = all[0]; endMs = all[all.length-1];
          startDateInput.value = toInputUTC(startMs);
          endDateInput.value   = toInputUTC(endMs);
        }
        applyFilter();
      }

      // ---------------- Synthèses (mensuelle/annuelle) ----------------
      function monthLabel(date){
        const M = ['janv','févr','mars','avr','mai','juin','juil','août','sept','oct','nov','déc'];
        return `${M[date.getMonth()]}-${String(date.getFullYear()).slice(-2)}`;
      }
      function generateSyntheses(fromDaily){
        const mapDebit = new Map(fromDaily.debit.map(d=>[d.date,d]));
        const mapPh    = new Map(fromDaily.ph.map(d=>[d.date,d]));
        const allDates = new Set([...mapDebit.keys(), ...mapPh.keys()]);
        const sorted = Array.from(allDates).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b));

        const mMap = new Map(); // YYYY-MM
        const yMap = new Map(); // YYYY

        for (const ds of sorted){
          const dUTC = dmyStrToUTCms(ds);
          const dObj = new Date(dUTC);
          const deb = mapDebit.get(ds);
          const ph  = mapPh.get(ds);

          const mKey = `${dObj.getUTCFullYear()}-${String(dObj.getUTCMonth()+1).padStart(2,'0')}`;
          if (!mMap.has(mKey)) mMap.set(mKey, {start:new Date(Date.UTC(dObj.getUTCFullYear(), dObj.getUTCMonth(),1)), label:monthLabel(new Date(dObj.getUTCFullYear(), dObj.getUTCMonth(),1)), d:[], p:[], ad:0, ap:0});
          const m = mMap.get(mKey);
          if (deb){ m.d.push(deb.value); if (deb.isAlert) m.ad++; }
          if (ph ){ m.p.push(ph.value);  if (ph.isAlert)  m.ap++; }

          const yKey = String(dObj.getUTCFullYear());
          if (!yMap.has(yKey)) yMap.set(yKey, {start:new Date(Date.UTC(dObj.getUTCFullYear(),0,1)), label:yKey, d:[], p:[], ad:0, ap:0});
          const y = yMap.get(yKey);
          if (deb){ y.d.push(deb.value); if (deb.isAlert) y.ad++; }
          if (ph ){ y.p.push(ph.value);  if (ph.isAlert)  y.ap++; }
        }

        filteredData.monthly = Array.from(mMap.values()).sort((a,b)=>a.start-b.start)
          .map(g=>({period:g.label, start:g.start, debitAvg:avg(g.d), phAvg:avg(g.p), debitAlerts:g.ad, phAlerts:g.ap}));
        filteredData.yearly = Array.from(yMap.values()).sort((a,b)=>a.start-b.start)
          .map(g=>({period:g.label, start:g.start, debitAvg:avg(g.d), phAvg:avg(g.p), debitAlerts:g.ad, phAlerts:g.ap}));

        function avg(arr){ return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0; }
      }

      // ---------------- Récap mensuel ----------------
      function buildMonthlyRecap(fromDaily){
        const buckets = new Map();
        const all = new Set([...fromDaily.debit.map(x=>x.date), ...fromDaily.ph.map(x=>x.date)]);
        Array.from(all).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).forEach(ds=>{
          const t = dmyStrToUTCms(ds);
          const dObj = new Date(t);
          const key = `${dObj.getUTCFullYear()}-${String(dObj.getUTCMonth()+1).padStart(2,'0')}`;
          if (!buckets.has(key)) buckets.set(key, {label:monthLabel(new Date(dObj.getUTCFullYear(), dObj.getUTCMonth(),1)), debit_lt2x:0, debit_gt2x:0, ph_lt2x:0, ph_gt2x:0});
          const b = buckets.get(key);
          const deb = fromDaily.debit.find(x=>x.date===ds);
          const ph  = fromDaily.ph.find(x=>x.date===ds);

          if (deb && deb.value>DEBIT_THRESHOLD){
            if (deb.value > 2*DEBIT_THRESHOLD) b.debit_gt2x++; else b.debit_lt2x++;
          }
          if (ph && (ph.value<PH_MIN || ph.value>PH_MAX)){
            const gt2 = (ph.value<PH_MIN && ph.value < 2*PH_MIN) || (ph.value>PH_MAX && ph.value > 2*PH_MAX);
            if (gt2) b.ph_gt2x++; else b.ph_lt2x++;
          }
        });
        return Array.from(buckets.values());
      }

      // ---------------- Alertes ----------------
      function generateAlerts(fromDaily){
        const alerts = [];
        fromDaily.debit.forEach(d=>{
          if (d.isAlert) alerts.push({date:d.date, type:'Débit', value:d.value, threshold:`> ${DEBIT_THRESHOLD}`, deviation:(d.value-DEBIT_THRESHOLD), severity:'high'});
        });
        fromDaily.ph.forEach(p=>{
          if (p.isAlert){
            const dev = p.value < PH_MIN ? (p.value-PH_MIN) : (p.value-PH_MAX);
            alerts.push({date:p.date, type:'pH', value:p.value, threshold:`${PH_MIN} - ${PH_MAX}`, deviation:dev, severity:'medium'});
          }
        });
        alerts.sort((a,b)=>dmyStrToUTCms(b.date) - dmyStrToUTCms(a.date));
        filteredData.alerts = alerts;
      }

      // ---------------- Rendu ----------------
      function rebuildAllViews(){
        generateSyntheses(filteredData.daily);
        generateAlerts(filteredData.daily);
        renderDaily();
        renderSyntheses();
        renderAlerts();
        setupExports();
      }

      function renderDaily(){
        const fmt = (n)=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
        const dRows = filteredData.daily.debit
          .sort((a,b)=>dmyStrToUTCms(a.date)-dmyStrToUTCms(b.date))
          .map(d=>`
            <tr class="${d.isAlert?'alert-row':''}">
              <td class="px-4 py-2 text-sm">${d.date}</td>
              <td class="px-4 py-2 text-sm font-medium">${fmt(d.value)}</td>
              <td class="px-4 py-2 text-sm">${d.isAlert?'<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">⚠️ Alerte</span>':'<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">✅ OK</span>'}</td>
            </tr>`).join('');
        document.getElementById('debitTable').innerHTML = dRows;

        const pRows = filteredData.daily.ph
          .sort((a,b)=>dmyStrToUTCms(a.date)-dmyStrToUTCms(b.date))
          .map(d=>`
            <tr class="${d.isAlert?'alert-row':''}">
              <td class="px-4 py-2 text-sm">${d.date}</td>
              <td class="px-4 py-2 text-sm font-medium">${fmt(d.value)}</td>
              <td class="px-4 py-2 text-sm">${d.isAlert?'<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">⚠️ Alerte</span>':'<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">✅ OK</span>'}</td>
            </tr>`).join('');
        document.getElementById('phTable').innerHTML = pRows;

        if (!filteredData.daily.debit.length && !filteredData.daily.ph.length){
          document.getElementById('debitTable').innerHTML = '<tr><td class="px-4 py-2 text-sm" colspan="3">Aucune donnée dans la période.</td></tr>';
          document.getElementById('phTable').innerHTML    = '<tr><td class="px-4 py-2 text-sm" colspan="3">Aucune donnée dans la période.</td></tr>';
        }
      }

      function renderSyntheses(){
        const fmt = (n)=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
        document.getElementById('monthlyTable').innerHTML = filteredData.monthly.map(m=>`
          <tr><td class="px-4 py-2 text-sm font-medium">${m.period}</td><td class="px-4 py-2 text-sm">${fmt(m.debitAvg)}</td><td class="px-4 py-2 text-sm">${fmt(m.phAvg)}</td><td class="px-4 py-2 text-sm">${m.debitAlerts}</td><td class="px-4 py-2 text-sm">${m.phAlerts}</td></tr>`).join('');
        document.getElementById('yearlyTable').innerHTML = filteredData.yearly.map(y=>`
          <tr><td class="px-4 py-2 text-sm font-medium">${y.period}</td><td class="px-4 py-2 text-sm">${fmt(y.debitAvg)}</td><td class="px-4 py-2 text-sm">${fmt(y.phAvg)}</td><td class="px-4 py-2 text-sm">${y.debitAlerts}</td><td class="px-4 py-2 text-sm">${y.phAlerts}</td></tr>`).join('');
      }

      function renderAlerts(){
        const fmt = (n)=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
        const rows = filteredData.alerts.map(a=>`
          <tr class="${a.severity==='high'?'alert-row':'warning-row'}">
            <td class="px-4 py-2 text-sm">${a.date}</td>
            <td class="px-4 py-2 text-sm font-medium">${a.type}</td>
            <td class="px-4 py-2 text-sm">${fmt(a.value)}</td>
            <td class="px-4 py-2 text-sm">${a.threshold}</td>
            <td class="px-4 py-2 text-sm font-medium">${fmt(a.deviation)}</td>
          </tr>`).join('');
        document.getElementById('alertsTable').innerHTML = rows;

        document.getElementById('alertsDebitCount').textContent = filteredData.alerts.filter(a=>a.type==='Débit').length;
        document.getElementById('alertsPhCount').textContent   = filteredData.alerts.filter(a=>a.type==='pH').length;
        document.getElementById('totalAlertsCount').textContent = filteredData.alerts.length;

        const worst = filteredData.alerts.reduce((m,a)=>Math.max(m, Math.abs(Number(a.deviation))), 0);
        document.getElementById('worstDeviation').textContent = worst ? fmt(worst) : '—';
      }

      // ---------------- Exports ----------------
      function setupExports(){
        document.getElementById('exportDailyBtn').onclick     = ()=>downloadCsv(generateDailyCsv(), 'donnees_journalieres.csv');
        document.getElementById('exportSynthesisBtn').onclick = ()=>downloadCsv(generateSynthesisCsv(), 'syntheses_mensuelle_annuelle.csv');
        document.getElementById('exportRecapBtn').onclick     = ()=>downloadCsv(generateRecapCsv(), 'recap_ecarts.csv');
        document.getElementById('exportAlertsBtn').onclick    = ()=>downloadCsv(generateAlertsCsv(), 'recap_alertes.csv');
        document.getElementById('exportExcelBtn').onclick     = ()=>downloadExcelFormatted();
      }

      function csvHeaderInfo(){
        const now = new Date();
        const range = `${startMs!=null?toInputUTC(startMs):'N/A'} -> ${endMs!=null?toInputUTC(endMs):'N/A'}`;
        return [
          '# Export ; Analyseur Débit & pH',
          `# Généré le ; ${now.toLocaleString('fr-FR')}`,
          `# Période filtrée ; ${range}`,
          '# ---'
        ].join('\r\n');
      }
      function q(value){ return `"${String(value).replace(/"/g,'""')}"`; }
      function numFR(n){ return Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}); }

      function generateDailyCsv(){
        const sep=';', NL='\r\n';
        let out = csvHeaderInfo()+NL;
        out += ['Date','Débit (dernière valeur)','Statut Débit','CouleurSouhaitée Débit','pH (moyenne)','Statut pH','CouleurSouhaitée pH'].map(q).join(sep)+NL;

        const mapD = new Map(filteredData.daily.debit.map(d=>[d.date,d]));
        const mapP = new Map(filteredData.daily.ph.map(d=>[d.date,d]));
        const all = new Set([...mapD.keys(), ...mapP.keys()]);
        const sorted = Array.from(all).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b));

        for (const ds of sorted){
          const d = mapD.get(ds);
          const p = mapP.get(ds);
          out += [
            q(ds),
            q(d?numFR(d.value):'N/A'),
            q(d?(d.isAlert?'ALERTE':'OK'):'N/A'),
            q(d?(d.isAlert?'ROUGE':'VERT'):'N/A'),
            q(p?numFR(p.value):'N/A'),
            q(p?(p.isAlert?'ALERTE':'OK'):'N/A'),
            q(p?(p.isAlert?'ROUGE':'VERT'):'N/A')
          ].join(sep)+NL;
        }
        return out;
      }

      function generateSynthesisCsv(){
        const sep=';', NL='\r\n';
        let out = csvHeaderInfo()+NL;
        out += ['Type','Période','Débit Moyen','pH Moyen','Alertes Débit','Alertes pH'].map(q).join(sep)+NL;

        filteredData.monthly.forEach(m=>{
          out += [q('Mois'), q(m.period), q(numFR(m.debitAvg)), q(numFR(m.phAvg)), q(m.debitAlerts), q(m.phAlerts)].join(sep)+NL;
        });
        filteredData.yearly.forEach(y=>{
          out += [q('Année'), q(y.period), q(numFR(y.debitAvg)), q(numFR(y.phAvg)), q(y.debitAlerts), q(y.phAlerts)].join(sep)+NL;
        });
        return out;
      }

      function generateRecapCsv(){
        const sep=';', NL='\r\n';
        let out = csvHeaderInfo()+NL;
        out += ['Mois','Nb dép. < 2×seuil - Débit','Nb dép. < 2×seuil - pH','Commentaires Débit','Commentaires pH','Nb dép. > 2×seuil - Débit','Nb dép. > 2×seuil - pH'].map(q).join(sep)+NL;
        const recap = buildMonthlyRecap(filteredData.daily);
        recap.forEach(r=>{
          out += [q(r.label), q(r.debit_lt2x), q(r.ph_lt2x), q('/'), q('/'), q(r.debit_gt2x), q(r.ph_gt2x)].join(sep)+NL;
        });
        return out;
      }

      function generateAlertsCsv(){
        const sep=';', NL='\r\n';
        let out = csvHeaderInfo()+NL;
        out += ['Date','Type','Valeur','Seuil','Écart'].map(q).join(sep)+NL;
        filteredData.alerts.forEach(a=>{
          out += [q(a.date), q(a.type), q(numFR(a.value)), q(a.threshold), q(numFR(a.deviation))].join(sep)+NL;
        });
        return out;
      }

      function downloadCsv(csvContent, fileName){
        // UTF-8 + BOM + CRLF
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent.replace(/\r?\n/g,'\r\n')], { type:'text/csv;charset=utf-8;' });
        saveAs(blob, fileName);
      }

      // ---------------- Excel "formaté" (couleurs + récap mensuel) ----------------
      function downloadExcelFormatted(){
        const fmt = (n)=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
        const dailyDates = Array.from(new Set([...filteredData.daily.debit.map(d=>d.date), ...filteredData.daily.ph.map(d=>d.date)])).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b));
        const mapD = new Map(filteredData.daily.debit.map(d=>[d.date,d]));
        const mapP = new Map(filteredData.daily.ph.map(d=>[d.date,d]));
        const recap = buildMonthlyRecap(filteredData.daily);

        const css = `
          <style>
            table { border-collapse: collapse; }
            td, th { border:1px solid #ccc; padding:4px 6px; font-family: Arial, sans-serif; font-size:12px; }
            .header { background:#1d4ed8; color:#fff; }
            .red { background:#ffcccc; }
            .green { background:#ccffcc; }
            .center { text-align:center; }
            .right { text-align:right; }
            .title { font-size:16px; font-weight:bold; padding:8px 0; }
          </style>
        `;

        // Feuille 1 : Journalier avec couleurs
        let sheet1 = `<div class="title">Données journalières (période ${startMs!=null?toInputUTC(startMs):'N/A'} → ${endMs!=null?toInputUTC(endMs):'N/A'})</div>`;
        sheet1 += `<table><thead><tr class="header"><th>Date</th><th>Débit</th><th>Statut Débit</th><th>pH</th><th>Statut pH</th></tr></thead><tbody>`;
        dailyDates.forEach(ds=>{
          const d = mapD.get(ds), p = mapP.get(ds);
          const dClass = d ? (d.isAlert?'red':'green') : '';
          const pClass = p ? (p.isAlert?'red':'green') : '';
          sheet1 += `<tr>
            <td>${ds}</td>
            <td class="right ${dClass}">${d?fmt(d.value):''}</td>
            <td class="center ${dClass}">${d?(d.isAlert?'ALERTE':'OK'):''}</td>
            <td class="right ${pClass}">${p?fmt(p.value):''}</td>
            <td class="center ${pClass}">${p?(p.isAlert?'ALERTE':'OK'):''}</td>
          </tr>`;
        });
        sheet1 += `</tbody></table>`;

        // Feuille 2 : Récap mensuel
        let sheet2 = `<div class="title" style="margin-top:14px;">Tableau récapitulatif mensuel</div>`;
        sheet2 += `<table><thead>
          <tr class="header"><th>Mois</th><th>Dépassements &lt; 2×seuil (Débit)</th><th>Dépassements &lt; 2×seuil (pH)</th><th>Commentaires Débit</th><th>Commentaires pH</th><th>Dépassements &gt; 2×seuil (Débit)</th><th>Dépassements &gt; 2×seuil (pH)</th></tr>
        </thead><tbody>`;
        recap.forEach(r=>{
          const c1 = r.debit_lt2x>0?'red':'green';
          const c2 = r.ph_lt2x>0?'red':'green';
          const c3 = r.debit_gt2x>0?'red':'green';
          const c4 = r.ph_gt2x>0?'red':'green';
          sheet2 += `<tr>
            <td>${r.label}</td>
            <td class="center ${c1}">${r.debit_lt2x}</td>
            <td class="center ${c2}">${r.ph_lt2x}</td>
            <td>/</td>
            <td>/</td>
            <td class="center ${c3}">${r.debit_gt2x}</td>
            <td class="center ${c4}">${r.ph_gt2x}</td>
          </tr>`;
        });
        sheet2 += `</tbody></table>`;

        const html = `<!DOCTYPE html><html><head><meta charset="UTF-8" />${css}</head><body>${sheet1}${sheet2}</body></html>`;
        const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
        saveAs(blob, 'export_formate.xls');
      }
    });
  </script>
</body>
</html>

