<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analyseur D√©bit & pH ‚Äî Mode debug</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Librairies fichiers -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    .upload-zone{border:2px dashed #d1d5db;transition:all .3s ease}
    .upload-zone:hover{border-color:#3b82f6;background:#f8fafc}
    .upload-zone.dragover{border-color:#2563eb;background:#eff6ff}
    .table-header{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    .nav-tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="modelBanner" class="hidden"><div id="modelBannerInner" class="max-w-7xl mx-auto px-4 py-3 text-sm"></div></div>

  <div class="container mx-auto px-4 py-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">üìä Analyseur D√©bit & pH ‚Äî <span class="text-purple-600">Mode debug</span></h1>
      <p class="text-gray-600">Mod√®le par d√©faut : <strong>Modele.xlsx</strong> (ou <strong>Mod√®le.xlsx</strong> en secours)</p>
      <label class="inline-flex items-center gap-2 mt-3">
        <input id="debugToggle" type="checkbox" class="w-4 h-4" checked>
        <span class="text-sm text-gray-700">Mode debug (logs d√©taill√©s dans la console)</span>
      </label>
    </header>

    <section class="bg-white rounded-lg shadow p-5 mb-6">
      <h2 class="text-xl font-semibold mb-4">üìÅ Importation</h2>
      <div class="grid md:grid-cols-2 gap-5">
        <div>
          <h3 class="font-medium text-gray-700 mb-2">üíß Fichier D√©bit (derni√®re valeur/jour)</h3>
          <div id="uploadZoneDebit" class="upload-zone rounded p-6 text-center cursor-pointer">
            <p class="text-sm text-gray-600">Cliquez / d√©posez le fichier D√©bit</p>
            <p class="text-xs text-gray-400">Seuil d'alerte D√©bit : ‚â• 220</p>
          </div>
          <input type="file" id="fileInputDebit" accept=".xlsx,.xls,.csv" class="hidden">
          <div id="fileInfoDebit" class="mt-2 hidden text-sm"><span id="fileNameDebit" class="font-medium"></span> <span id="fileSizeDebit" class="text-gray-500"></span></div>
        </div>
        <div>
          <h3 class="font-medium text-gray-700 mb-2">üß™ Fichier pH (moyenne/jour)</h3>
          <div id="uploadZonePh" class="upload-zone rounded p-6 text-center cursor-pointer">
            <p class="text-sm text-gray-600">Cliquez / d√©posez le fichier pH</p>
            <p class="text-xs text-gray-400">Seuils pH : ‚â§ 5.5 ou ‚â• 8.5</p>
          </div>
          <input type="file" id="fileInputPh" accept=".xlsx,.xls,.csv" class="hidden">
          <div id="fileInfoPh" class="mt-2 hidden text-sm"><span id="fileNamePh" class="font-medium"></span> <span id="fileSizePh" class="text-gray-500"></span></div>
        </div>
      </div>

      <div class="flex gap-3 mt-5">
        <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded disabled:bg-gray-300" disabled>Analyser</button>
        <button id="exportExcelTemplateBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded disabled:bg-gray-300" disabled>Excel identique (via mod√®le)</button>
        <button id="exportExcelBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Excel fallback</button>
      </div>
      <p id="activeRange" class="text-xs text-gray-600 mt-2 hidden"></p>
    </section>
  </div>

  <script>
    // ===== Debug =====
    let DEBUG = true;
    const log = (...args)=>{ if(DEBUG) console.log(...args); };
    const group = (label)=>{ if(DEBUG) console.group(label); };
    const groupEnd = ()=>{ if(DEBUG) console.groupEnd(); };
    const groupC = (label)=>{ if(DEBUG) console.groupCollapsed(label); };

    document.getElementById('debugToggle').addEventListener('change', e => { DEBUG = e.target.checked; });

    // ===== √âtat =====
    let debitData = [], phData = [];
    let processedData = { daily:{debit:[], ph:[] } };
    let filteredData  = { daily:{debit:[], ph:[] } };
    let templateArrayBuffer = null, templateLoaded = false;

    // Seuils
    const DEBIT_THRESHOLD = 220;
    const PH_MIN = 5.5, PH_MAX = 8.5;

    // Couleurs ARGB + format
    const FILL_RED   = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFFF0000' } };
    const FILL_GREEN = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF00B050' } };
    const NUM_FMT    = '0.00';

    const MONTH_MAP_2025 = {
      0: { label:'JANVIER',   jourCol:'B', debitCol:'C', phCol:'D', startRow:14, endRow:44 }, // 31
      1: { label:'F√âVRIER',   jourCol:'G', debitCol:'H', phCol:'I', startRow:14, endRow:41 }, // 28
      2: { label:'MARS',      jourCol:'L', debitCol:'M', phCol:'N', startRow:14, endRow:44 }, // 31
      3: { label:'AVRIL',     jourCol:'B', debitCol:'C', phCol:'D', startRow:50, endRow:79 }, // 30
      4: { label:'MAI',       jourCol:'G', debitCol:'H', phCol:'I', startRow:50, endRow:80 }, // 31
      5: { label:'JUIN',      jourCol:'L', debitCol:'M', phCol:'N', startRow:50, endRow:79 }, // 30
      6: { label:'JUILLET',   jourCol:'B', debitCol:'C', phCol:'D', startRow:86, endRow:116}, // 31
      7: { label:'AO√õT',      jourCol:'G', debitCol:'H', phCol:'I', startRow:86, endRow:116}, // 31
      8: { label:'SEPTEMBRE', jourCol:'L', debitCol:'M', phCol:'N', startRow:86, endRow:115}  // 30
    };

    function isDebitAlert(v){ return typeof v === 'number' && isFinite(v) && v >= DEBIT_THRESHOLD; }
    function isPhAlert(v){ return typeof v === 'number' && isFinite(v) && (v <= PH_MIN || v >= PH_MAX); }
    function colorize(cell, alert){ cell.fill = (alert === null) ? null : (alert ? FILL_RED : FILL_GREEN); }

    // ===== Banni√®re =====
    function showModelBanner(type, html){
      const bar = document.getElementById('modelBanner');
      const inner = document.getElementById('modelBannerInner');
      inner.innerHTML = html;
      const classes = {
        info:'bg-blue-50 text-blue-800 border border-blue-200',
        ok:'bg-green-50 text-green-800 border border-green-200',
        warn:'bg-amber-50 text-amber-800 border border-amber-200',
        error:'bg-red-50 text-red-800 border border-red-200'
      };
      bar.className=''; bar.classList.add(classes[type]||classes.info); bar.classList.remove('hidden');
    }

    // ===== Chargement mod√®le =====
    async function loadDefaultTemplate(){
      if (location.protocol === 'file:'){
        showModelBanner('warn','Page ouverte en <code>file://</code>. Servez ce dossier via <code>python -m http.server</code> (ou Live Server) pour charger <b>Modele.xlsx</b>.');
        updateTemplateButtonState();
        return;
      }
      async function tryFetch(path){ try{ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) return null; return {name:path, buf:await r.arrayBuffer()}; }catch(_){ return null; } }
      let res = await tryFetch('Modele.xlsx'); if(!res) res = await tryFetch('Mod√®le.xlsx');
      if (res){ templateArrayBuffer=res.buf; templateLoaded=true; showModelBanner('ok',`Mod√®le charg√© : <b>${res.name}</b>.`); }
      else { templateLoaded=false; showModelBanner('error','Impossible de charger <b>Modele.xlsx</b> (ou <b>Mod√®le.xlsx</b>).'); }
      updateTemplateButtonState();
    }
    function updateTemplateButtonState(){
      const b=document.getElementById('exportExcelTemplateBtn'); if(!b) return;
      b.disabled=!templateLoaded; b.classList.toggle('opacity-60',!templateLoaded);
    }

    // ===== INIT UI =====
    window.addEventListener('load',()=>{
      setupFileUpload('Debit',(d)=>{debitData=d; log('Debit rows:', d.length); checkReady();});
      setupFileUpload('Ph',(d)=>{phData=d; log('pH rows:', d.length); checkReady();});
      loadDefaultTemplate();
      document.getElementById('analyzeBtn').addEventListener('click', onAnalyze);
      document.getElementById('exportExcelTemplateBtn').addEventListener('click', exportExcelUsingTemplate);
      document.getElementById('exportExcelBtn').addEventListener('click', exportExcelFallback);
    });

    function checkReady(){
      const ready = debitData.length && phData.length;
      document.getElementById('analyzeBtn').disabled = !ready;
    }

    // ===== Upload helpers =====
    function setupFileUpload(type, callback){
      const z=document.getElementById(`uploadZone${type}`);
      const i=document.getElementById(`fileInput${type}`);
      const info=document.getElementById(`fileInfo${type}`);
      const fn=document.getElementById(`fileName${type}`);
      const fs=document.getElementById(`fileSize${type}`);

      z.addEventListener('click',()=>i.click());
      z.addEventListener('dragover',e=>{e.preventDefault();z.classList.add('dragover');});
      z.addEventListener('dragleave',()=>z.classList.remove('dragover'));
      z.addEventListener('drop',e=>{e.preventDefault();z.classList.remove('dragover'); if(e.dataTransfer.files.length) handle(e.dataTransfer.files[0]);});
      i.addEventListener('change',e=>{ if(e.target.files.length) handle(e.target.files[0]); });

      function handle(file){
        fn.textContent=file.name; fs.textContent=`(${(file.size/1024/1024).toFixed(2)} MB)`; info.classList.remove('hidden');
        const reader=new FileReader();
        reader.onload=(ev)=>{
          try{
            let data;
            if (file.name.toLowerCase().endsWith('.csv')){
              const text=ev.target.result;
              const lines=text.split(/\r?\n/).filter(l=>l.trim());
              const sep = ((lines[0].match(/;/g)||[]).length >= (lines[0].match(/,/g)||[]).length) ? ';' : ',';
              data = lines.map(line=>line.split(sep).map(c=>c.trim()));
            } else {
              const wb=XLSX.read(ev.target.result,{type:'array'});
              const ws=wb.Sheets[wb.SheetNames[0]];
              data=XLSX.utils.sheet_to_json(ws,{header:1});
            }
            // nettoyage basique
            const clean=(data||[]).filter(r=>r&&r.length>1&&r[0]!==''&&r[1]!=='' );
            callback(clean);
          }catch(err){ console.error(err); alert(`Erreur lecture fichier ${type}`); }
        };
        if (file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file); else reader.readAsArrayBuffer(file);
      }
    }

    // ===== Dates & parse =====
    function parseInputDateUTC(s){ const m=String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return null; return Date.UTC(+m[1],+m[2]-1,+m[3]);}
    function parseDMYtoUTC(s){ const m=String(s||'').match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})$/); if(!m) return null; let y=+m[3]; if(y<100) y+=2000; return Date.UTC(y,+m[2]-1,+m[1]);}
    function parseExcelSerialUTC(s){ const txt=String(s||'').trim(); if(!/^\d{1,5}(\.\d+)?$/.test(txt)) return null; const serial=Math.floor(+txt); const epoch=Date.UTC(1899,11,30); return epoch+serial*86400000;}
    function parseAnyToUTC(s){ if(s===null||s===undefined||s==='') return null; return parseExcelSerialUTC(s)??parseDMYtoUTC(s)??parseInputDateUTC(s);}
    function dmyStrToUTCms(dmy){ let t=parseDMYtoUTC(dmy); if(t!==null) return t; return parseAnyToUTC(dmy); }
    function parseDateLoose(dateStr){
      const utc=parseAnyToUTC(dateStr); if(utc!==null) return new Date(utc);
      const parts=String(dateStr).trim().split(' '); const [d,m,y]=parts[0].split('/'); let H=0,M=0,S=0; if(parts[1]) [H,M,S]=parts[1].split(':').map(v=>parseInt(v||0,10));
      return new Date(Number(y),Number(m)-1,Number(d),H||0,M||0,S||0);
    }
    function formatDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }

    function onAnalyze(){
      processedData.daily.debit = processDebitData(debitData);
      processedData.daily.ph    = processPhData(phData);

      // logs
      groupC('üßÆ R√©sum√© donn√©es journali√®res');
      log('D√©bit (n=', processedData.daily.debit.length, '):', processedData.daily.debit.slice(0,5), '...');
      log('pH    (n=', processedData.daily.ph.length, '):', processedData.daily.ph.slice(0,5), '...');
      groupEnd();

      filteredData.daily.debit = processedData.daily.debit;
      filteredData.daily.ph    = processedData.daily.ph;
      document.getElementById('exportExcelTemplateBtn').disabled = !templateLoaded;
    }

    function processDebitData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v)) return;
        const d=parseDateLoose(dateStr);
        const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push({time:d,value:v});
      });
      const out = Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=perDay[k].sort((a,b)=>a.time-b.time); const last=arr[arr.length-1].value;
        return {date:k, value:last, isAlert:isDebitAlert(last), count:arr.length};
      });
      groupC('üíß D√©bit ‚Äî agr√©gation');
      out.slice(0,10).forEach(r=>log(r));
      groupEnd();
      return out;
    }

    function processPhData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v) || v===0) return;
        const d=parseDateLoose(dateStr); const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push(v);
      });
      const out = Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=(perDay[k]||[]).filter(v=>isFinite(v)&&v!==0);
        if(!arr.length) return null;
        const avg=arr.reduce((a,b)=>a+b,0)/arr.length;
        return {date:k, value:avg, isAlert:isPhAlert(avg), count:arr.length};
      }).filter(Boolean);
      groupC('üß™ pH ‚Äî agr√©gation');
      out.slice(0,10).forEach(r=>log(r));
      groupEnd();
      return out;
    }

    // ===== Export via mod√®le (avec logs d√©taill√©s) =====
    async function exportExcelUsingTemplate(){
      if(!filteredData.daily.debit.length&&!filteredData.daily.ph.length){ alert('Aucune donn√©e.'); return; }
      if(!templateLoaded||!templateArrayBuffer){ alert('Mod√®le non charg√©.'); return; }

      const workbook=new ExcelJS.Workbook(); await workbook.xlsx.load(templateArrayBuffer);
      const sheetNameCandidates=['suivi des d√©bits et du pH','suivi des d√©bits et du pH (2)'];
      let ws=null; for(const name of sheetNameCandidates){ const t=workbook.getWorksheet(name); if(t){ ws=t; break; } } if(!ws) ws=workbook.worksheets[0];

      // Neutralisation MFC
      try{
        if (Array.isArray(ws.conditionalFormattings)) ws.conditionalFormattings = [];
        if (ws.model && Array.isArray(ws.model.conditionalFormattings)) ws.model.conditionalFormattings = [];
        if (ws._model && Array.isArray(ws._model.conditionalFormattings)) ws._model.conditionalFormattings = [];
        log('‚úî Mises en forme conditionnelles neutralis√©es (si pr√©sentes)');
      }catch(e){ log('‚Ñπ Pas de MFC d√©tect√©e / non accessible'); }

      // Reset valeurs/couleurs des plages (surtout colonnes valeurs)
      const zones = [
        {cols:['B','C','D'], from:14, to:44}, // Jan
        {cols:['G','H','I'], from:14, to:41}, // F√©v
        {cols:['L','M','N'], from:14, to:44}, // Mar
        {cols:['B','C','D'], from:50, to:79}, // Avr
        {cols:['G','H','I'], from:50, to:80}, // Mai
        {cols:['L','M','N'], from:50, to:79}, // Juin
        {cols:['B','C','D'], from:86, to:116},// Juil
        {cols:['G','H','I'], from:86, to:116},// Ao√ªt
        {cols:['L','M','N'], from:86, to:115} // Sept
      ];
      zones.forEach(z=>{
        for(let r=z.from;r<=z.to;r++){
          z.cols.forEach(c=>{
            if(c==='B'||c==='G'||c==='L') return; // ne pas toucher aux dates d√©j√† en place
            const cell=ws.getCell(`${c}${r}`);
            cell.value = null;
            cell.fill  = null;
          });
        }
      });
      log('‚úî Reset des zones valeurs (C/D, H/I, M/N) effectu√©');

      // Maps journali√®res
      const dMap=new Map(filteredData.daily.debit.map(d=>[d.date,d]));
      const pMap=new Map(filteredData.daily.ph.map(d=>[d.date,d]));
      const allDates=new Set([...dMap.keys(),...pMap.keys()]);
      const sorted=Array.from(allDates).map(d=>({dStr:d, t:dmyStrToUTCms(d)})).filter(o=>o.t!=null).sort((a,b)=>a.t-b.t);

      let writeCount=0, redCount=0, greenCount=0, skippedCount=0;

      groupC('‚úçÔ∏è √âcriture cellule par cellule');
      sorted.forEach(o=>{
        const dt = new Date(o.t);
        const year = dt.getUTCFullYear();
        if(year!==2025){ skippedCount++; return; }
        const m=dt.getUTCMonth();
        const cfg = MONTH_MAP_2025[m]; if(!cfg){ skippedCount++; return; }
        const day = dt.getUTCDate();
        const row = cfg.startRow + (day - 1);
        if(row<cfg.startRow || row>cfg.endRow){ skippedCount++; return; }

        const jourAddr = `${cfg.jourCol}${row}`;
        const debAddr  = `${cfg.debitCol}${row}`;
        const phAddr   = `${cfg.phCol}${row}`;

        const jourCell = ws.getCell(jourAddr);
        if(!jourCell.value) jourCell.value = new Date(Date.UTC(2025,m,day,23,59,59));

        const dRec = dMap.get(o.dStr);
        const pRec = pMap.get(o.dStr);

        // D√©bit
        if(dRec){
          const val = Number(dRec.value);
          const isNum = typeof val === 'number' && isFinite(val);
          const alert = isNum ? isDebitAlert(val) : null;

          const cell=ws.getCell(debAddr);
          cell.value = isNum ? val : null;
          cell.numFmt = isNum ? NUM_FMT : undefined;
          cell.fill = null; // reset avant
          colorize(cell, alert);

          writeCount++; if(alert===true) redCount++; if(alert===false) greenCount++;
          groupC(`D√©bit ${o.dStr} -> ${debAddr}`);
          log({ value:val, type:typeof val, isFinite:isFinite(val), alert:(alert===null?'N/A':alert?'ROUGE':'VERT') });
          groupEnd();
        }

        // pH
        if(pRec){
          const val = Number(pRec.value);
          const isNum = typeof val === 'number' && isFinite(val);
          const alert = isNum ? isPhAlert(val) : null;

          const cell=ws.getCell(phAddr);
          cell.value = isNum ? val : null;
          cell.numFmt = isNum ? NUM_FMT : undefined;
          cell.fill = null;
          colorize(cell, alert);

          writeCount++; if(alert===true) redCount++; if(alert===false) greenCount++;
          groupC(`pH ${o.dStr} -> ${phAddr}`);
          log({ value:val, type:typeof val, isFinite:isFinite(val), alert:(alert===null?'N/A':alert?'ROUGE':'VERT') });
          groupEnd();
        }
      });
      groupEnd();

      log('R√©sum√© √©criture :', { ecrites:writeCount, rouges:redCount, vertes:greenCount, ignorees_hors_plage:skippedCount });

      const buf=await workbook.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),'export_identique_DEBUG.xlsx');
      log('üìÅ Fichier export_identique_DEBUG.xlsx g√©n√©r√©.');
    }

    // ===== Export fallback (simple, avec logs light) =====
    async function exportExcelFallback(){
      if(!filteredData.daily.debit.length&&!filteredData.daily.ph.length){ alert('Aucune donn√©e.'); return; }
      const wb=new ExcelJS.Workbook(), ws=wb.addWorksheet('suivi des d√©bits et du pH');
      ws.addRow(['Date','D√©bit','pH','Statut D√©bit','Statut pH']);
      const dMap=new Map(filteredData.daily.debit.map(d=>[d.date,d]));
      const pMap=new Map(filteredData.daily.ph.map(d=>[d.date,d]));
      const all=new Set([...dMap.keys(),...pMap.keys()]);
      const sorted=Array.from(all).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b));
      sorted.forEach(ds=>{
        const dRec=dMap.get(ds), pRec=pMap.get(ds);
        const dv = dRec?Number(dRec.value):null;
        const pv = pRec?Number(pRec.value):null;
        const r=ws.addRow([ds, dv, pv, dRec?(isDebitAlert(dv)?'ALERTE':'OK'):'', pRec?(isPhAlert(pv)?'ALERTE':'OK'):'' ]);
        if(dRec){ colorize(r.getCell(2), isFinite(dv)?isDebitAlert(dv):null); r.getCell(2).numFmt=NUM_FMT; }
        if(pRec){ colorize(r.getCell(3), isFinite(pv)?isPhAlert(pv):null); r.getCell(3).numFmt=NUM_FMT; }
      });
      const buf=await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),'export_fallback_DEBUG.xlsx');
      log('üìÅ Fichier export_fallback_DEBUG.xlsx g√©n√©r√©.');
    }
  </script>
</body>
</html>
