<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Analyseur D√©bit & pH ‚Äî Mod√®le par d√©faut (MFC + fallback)</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Librairies -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    .upload-zone{border:2px dashed #d1d5db;transition:all .2s ease}
    .upload-zone:hover{border-color:#3b82f6;background:#f8fafc}
    .upload-zone.dragover{border-color:#2563eb;background:#eff6ff}
    .table-header{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    .nav-tab{transition:all .2s ease}
    .nav-tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
    .ok-pill{background:#dcfce7;color:#166534}
    .ko-pill{background:#fee2e2;color:#991b1b}
    .alert-row{background:#fef2f2!important}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="banner" class="hidden"></div>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">üìä Analyseur D√©bit & pH ‚Äî Mod√®le par d√©faut</h1>
      <p class="text-gray-600">Le mod√®le <b>Mod√®le.xlsx</b> est charg√© automatiquement (ou <b>Modele.xlsx</b>). Couleurs via <b>MFC si dispo</b>, sinon <b>fallback</b> (rouge/vert en dur).</p>
    </header>

    <section class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÅ Fichiers</h2>

      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">üíß Fichier D√©bit</h3>
          <div id="uploadZoneDebit" class="upload-zone rounded-lg p-5 text-center cursor-pointer">
            <p class="text-sm text-gray-600">Cliquez / d√©posez</p>
            <p class="text-xs text-gray-400">Seuil alerte : ‚â• 220</p>
          </div>
          <input type="file" id="fileInputDebit" accept=".xlsx,.xls,.csv" class="hidden">
          <div id="fileInfoDebit" class="mt-2 hidden text-sm"><span id="fileNameDebit" class="font-medium"></span> <span id="fileSizeDebit" class="text-gray-500"></span></div>
        </div>

        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">üß™ Fichier pH</h3>
          <div id="uploadZonePh" class="upload-zone rounded-lg p-5 text-center cursor-pointer">
            <p class="text-sm text-gray-600">Cliquez / d√©posez</p>
            <p class="text-xs text-gray-400">Seuils : ‚â§ 5.5 ou ‚â• 8.5</p>
          </div>
          <input type="file" id="fileInputPh" accept=".xlsx,.xls,.csv" class="hidden">
          <div id="fileInfoPh" class="mt-2 hidden text-sm"><span id="fileNamePh" class="font-medium"></span> <span id="fileSizePh" class="text-gray-500"></span></div>
        </div>

        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">üìÑ Mod√®le (charg√© par d√©faut)</h3>
          <div class="rounded-lg p-5 bg-blue-50 border border-blue-200 text-blue-800 text-sm">
            Recherche <b>Mod√®le.xlsx</b> (ou <b>Modele.xlsx</b>) dans ce dossier.
            <div id="modelStatus" class="mt-1 text-xs text-blue-700"></div>
          </div>
        </div>
      </div>

      <!-- Filtres date -->
      <div class="grid gap-3 sm:grid-cols-[1fr_1fr_auto_auto] items-end mt-6">
        <div>
          <label for="startDate" class="block text-sm text-gray-600">Du</label>
          <input id="startDate" type="date" class="w-full border rounded-lg px-3 py-2"/>
        </div>
        <div>
          <label for="endDate" class="block text-sm text-gray-600">Au</label>
          <input id="endDate" type="date" class="w-full border rounded-lg px-3 py-2"/>
        </div>
        <button id="applyFilterBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:bg-gray-300" disabled>Appliquer</button>
        <button id="resetFilterBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium disabled:bg-gray-200" disabled>R√©initialiser</button>
      </div>

      <div class="mt-5 flex gap-3">
        <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium disabled:bg-gray-300" disabled>üîç Analyser</button>
        <button id="exportTemplateBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg font-medium" disabled>üì• Excel (via Mod√®le)</button>
      </div>
    </section>

    <section id="resultsSection" class="hidden">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex border-b border-gray-200 mb-4">
          <button class="nav-tab active px-5 py-2 font-medium rounded-tl-lg" data-tab="daily">üìÖ Donn√©es journali√®res</button>
          <button class="nav-tab px-5 py-2 font-medium" data-tab="alerts">‚ö†Ô∏è R√©cap alertes</button>
        </div>

        <div id="dailyTab" class="tab-content">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold text-blue-600 mb-2">üíß D√©bit (derni√®re valeur/jour)</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                  <thead class="table-header text-white">
                    <tr><th class="px-3 py-2 text-xs uppercase">Date</th><th class="px-3 py-2 text-xs uppercase">Valeur</th><th class="px-3 py-2 text-xs uppercase">√âtat</th></tr>
                  </thead>
                  <tbody id="debitTable" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-green-600 mb-2">üß™ pH (moyenne/jour)</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                  <thead class="table-header text-white">
                    <tr><th class="px-3 py-2 text-xs uppercase">Date</th><th class="px-3 py-2 text-xs uppercase">Moyenne</th><th class="px-3 py-2 text-xs uppercase">√âtat</th></tr>
                  </thead>
                  <tbody id="phTable" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="alertsTab" class="tab-content hidden">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">‚ö†Ô∏è R√©capitulatif des alertes</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
              <thead class="table-header text-white">
                <tr><th class="px-3 py-2 text-xs uppercase">Date</th><th class="px-3 py-2 text-xs uppercase">Type</th><th class="px-3 py-2 text-xs uppercase">Valeur</th><th class="px-3 py-2 text-xs uppercase">Seuil</th></tr>
              </thead>
              <tbody id="alertsTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    // ---------------------- CONSTANTES ----------------------
    const DEBIT_THRESHOLD = 220;
    const PH_MIN = 5.5, PH_MAX = 8.5;
    const NUM_FMT = '0.00';

    // mapping exact 2025
    const MONTH_MAP_2025 = {
      0: { jourCol:'B', debitCol:'C', phCol:'D', startRow:14, endRow:44 }, // Jan
      1: { jourCol:'G', debitCol:'H', phCol:'I', startRow:14, endRow:41 }, // F√©v
      2: { jourCol:'L', debitCol:'M', phCol:'N', startRow:14, endRow:44 }, // Mar
      3: { jourCol:'B', debitCol:'C', phCol:'D', startRow:50, endRow:79 }, // Avr
      4: { jourCol:'G', debitCol:'H', phCol:'I', startRow:50, endRow:80 }, // Mai
      5: { jourCol:'L', debitCol:'M', phCol:'N', startRow:50, endRow:79 }, // Juin
      6: { jourCol:'B', debitCol:'C', phCol:'D', startRow:86, endRow:116}, // Juil
      7: { jourCol:'G', debitCol:'H', phCol:'I', startRow:86, endRow:116}, // Ao√ªt
      8: { jourCol:'L', debitCol:'M', phCol:'N', startRow:86, endRow:115}  // Sept
    };

    // Couleurs directes (fallback)
    const FILL_RED   = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFFF0000' } };
    const FILL_GREEN = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF00B050' } };

    // ---------------------- √âTAT ----------------------
    let templateArrayBuffer = null;
    let debitData = [], phData = [];
    let processed = { daily:{debit:[], ph:[]}, filtered:{debit:[], ph:[]}, alerts:[], allUTC:[] };
    let startMs=null, endMs=null;

    // ---------------------- HELPERS ----------------------
    const showBanner = (type,msg)=>{
      const b=document.getElementById('banner');
      const cls = {
        ok:'bg-green-50 text-green-800 border border-green-200',
        warn:'bg-amber-50 text-amber-800 border border-amber-200',
        err:'bg-red-50 text-red-800 border border-red-200',
        info:'bg-blue-50 text-blue-800 border border-blue-200'
      }[type]||'bg-blue-50 text-blue-800 border border-blue-200';
      b.className=cls+' max-w-7xl mx-auto px-4 py-3 rounded mb-4';
      b.innerHTML=msg; b.classList.remove('hidden');
    };

    function detectSep(headerLine){
      const sc=(headerLine.match(/;/g)||[]).length, cc=(headerLine.match(/,/g)||[]).length; return sc>=cc?';':',';
    }
    function parseInputDateUTC(s){ const m=String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return null; return Date.UTC(+m[1],+m[2]-1,+m[3]);}
    function parseDMYtoUTC(s){ const m=String(s||'').match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})$/); if(!m) return null; let y=+m[3]; if(y<100) y+=2000; return Date.UTC(y,+m[2]-1,+m[1]);}
    function parseExcelSerialUTC(s){ const txt=String(s||'').trim(); if(!/^\d{1,5}(\.\d+)?$/.test(txt)) return null; const serial=Math.floor(+txt); const epoch=Date.UTC(1899,11,30); return epoch+serial*86400000;}
    function parseAnyToUTC(s){ if(s===null||s===undefined||s==='') return null; return parseExcelSerialUTC(s)??parseDMYtoUTC(s)??parseInputDateUTC(s);}
    function dmyStrToUTCms(dmy){ let t=parseDMYtoUTC(dmy); if(t!==null) return t; return parseAnyToUTC(dmy); }
    function parseDateLoose(dateStr){
      const utc=parseAnyToUTC(dateStr); if(utc!==null) return new Date(utc);
      const parts=String(dateStr).trim().split(' '); const [d,m,y]=parts[0].split('/'); let H=0,M=0,S=0; if(parts[1]) [H,M,S]=parts[1].split(':').map(v=>parseInt(v||0,10));
      return new Date(Number(y),Number(m)-1,Number(d),H||0,M||0,S||0);
    }
    function formatDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }
    function toInputUTC(ms){ const d=new Date(ms); const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), day=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function isDebitAlert(v){ return typeof v === 'number' && isFinite(v) && v >= DEBIT_THRESHOLD; }
    function isPhAlert(v){ return typeof v === 'number' && isFinite(v) && (v <= PH_MIN || v >= PH_MAX); }
    function colorize(cell, alert){ cell.fill = (alert===null) ? null : (alert ? FILL_RED : FILL_GREEN); }

    // ---------------------- INIT ----------------------
    window.addEventListener('load',()=>{
      // uploads
      setupFileUpload('Debit',(d)=>{debitData=d; setReady();});
      setupFileUpload('Ph',(d)=>{phData=d; setReady();});

      // mod√®le par d√©faut
      loadDefaultTemplate();

      // actions
      document.getElementById('analyzeBtn').addEventListener('click', analyze);
      document.getElementById('exportTemplateBtn').addEventListener('click', exportWithTemplate);
      document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
      document.getElementById('resetFilterBtn').addEventListener('click', resetFilter);
      document.getElementById('startDate').addEventListener('change', applyFilter);
      document.getElementById('endDate').addEventListener('change', applyFilter);
    });

    function setReady(){
      const ready = debitData.length && phData.length;
      document.getElementById('analyzeBtn').disabled = !ready;
      document.getElementById('applyFilterBtn').disabled = !ready;
      document.getElementById('resetFilterBtn').disabled = !ready;
    }

    function setupFileUpload(type, callback){
      const z=document.getElementById(`uploadZone${type}`);
      const i=document.getElementById(`fileInput${type}`);
      const info=document.getElementById(`fileInfo${type}`);
      const fn=document.getElementById(`fileName${type}`);
      const fs=document.getElementById(`fileSize${type}`);

      z.addEventListener('click',()=>i.click());
      z.addEventListener('dragover',e=>{e.preventDefault();z.classList.add('dragover');});
      z.addEventListener('dragleave',()=>z.classList.remove('dragover'));
      z.addEventListener('drop',e=>{e.preventDefault();z.classList.remove('dragover'); if(e.dataTransfer.files.length) handle(e.dataTransfer.files[0]);});
      i.addEventListener('change',e=>{ if(e.target.files.length) handle(e.target.files[0]); });

      function handle(file){
        fn.textContent=file.name; fs.textContent=`(${(file.size/1024/1024).toFixed(2)} MB)`; info.classList.remove('hidden');
        const reader=new FileReader();
        reader.onload=(ev)=>{
          try{
            let data;
            if (file.name.toLowerCase().endsWith('.csv')){
              const text=ev.target.result;
              const lines=text.split(/\r?\n/).filter(l=>l.trim());
              const sep=detectSep(lines[0]);
              data = lines.map(line=>line.split(sep).map(c=>c.trim()));
            } else {
              const wb=XLSX.read(ev.target.result,{type:'array'});
              const ws=wb.Sheets[wb.SheetNames[0]];
              data=XLSX.utils.sheet_to_json(ws,{header:1});
            }
            const clean=(data||[]).filter(r=>r&&r.length>1&&r[0]!==''&&r[1]!=='' );
            callback(clean);
          }catch(err){ console.error(err); alert(`Erreur lecture fichier ${type}`); }
        };
        if (file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file); else reader.readAsArrayBuffer(file);
      }
    }

    // ---------------------- MOD√àLE ----------------------
    async function loadDefaultTemplate(){
      const statusEl=document.getElementById('modelStatus');
      if (location.protocol==='file:'){
        showBanner('warn','Page ouverte en <code>file://</code> ‚Üí les navigateurs bloquent <code>fetch()</code> local. Servez ce dossier via <code>python -m http.server</code> ou Live Server pour charger <b>Mod√®le.xlsx</b>.');
        statusEl.textContent='En attente d‚Äôun serveur local (http://).';
        return;
      }
      async function tryFetch(name){
        try{ const r=await fetch(name,{cache:'no-store'}); if(!r.ok) return null; return await r.arrayBuffer(); }
        catch(_){ return null; }
      }
      let buf = await tryFetch('Mod√®le.xlsx'); if(!buf) buf = await tryFetch('Modele.xlsx');
      if(!buf){ showBanner('err','Impossible de charger <b>Mod√®le.xlsx</b> (ou <b>Modele.xlsx</b>) dans ce dossier.'); statusEl.textContent='Mod√®le non charg√©.'; return; }
      templateArrayBuffer = buf;
      statusEl.textContent='Mod√®le charg√© ‚úî';
      updateExportState();
    }

    function updateExportState(){
      const enabled = !!templateArrayBuffer && (processed.filtered?.debit?.length || processed.filtered?.ph?.length);
      const btn = document.getElementById('exportTemplateBtn');
      btn.disabled = !enabled;
      btn.title = enabled ? '' : 'Importez, analysez et filtrez vos donn√©es';
    }

    // ---------------------- ANALYSE & FILTRE ----------------------
    function analyze(){
      processed.daily.debit = processDebitData(debitData);
      processed.daily.ph    = processPhData(phData);

      // bornes
      const allUTC = Array.from(new Set([...processed.daily.debit.map(d=>d.date), ...processed.daily.ph.map(p=>p.date)]))
        .map(d=>dmyStrToUTCms(d)).filter(Boolean).sort((a,b)=>a-b);
      processed.allUTC = allUTC.slice();
      if (allUTC.length){
        startMs = allUTC[0]; endMs = allUTC[allUTC.length-1];
        document.getElementById('startDate').value = toInputUTC(startMs);
        document.getElementById('endDate').value   = toInputUTC(endMs);
      } else { startMs=endMs=null; }

      applyFilter();
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    function processDebitData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v)) return;
        const d=parseDateLoose(dateStr);
        const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push({time:d,value:v});
      });
      return Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=perDay[k].sort((a,b)=>a.time-b.time); const last=arr[arr.length-1].value;
        return {date:k, value:last};
      });
    }
    function processPhData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v) || v===0) return;
        const d=parseDateLoose(dateStr); const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push(v);
      });
      return Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=(perDay[k]||[]).filter(v=>isFinite(v)&&v!==0);
        if(!arr.length) return null;
        const avg=arr.reduce((a,b)=>a+b,0)/arr.length;
        return {date:k, value:avg};
      }).filter(Boolean);
    }

    function applyFilter(){
      const s=parseInputDateUTC(document.getElementById('startDate').value);
      const e=parseInputDateUTC(document.getElementById('endDate').value);
      startMs = s!=null?s:null; endMs = e!=null?e:null;

      const inRange=(dmy)=>{
        const t=dmyStrToUTCms(dmy); if(t==null) return false;
        const endInclusive=(endMs!=null)?(endMs+86400000-1):null;
        if(startMs!=null && t<startMs) return false;
        if(endInclusive!=null && t>endInclusive) return false;
        return true;
      };
      processed.filtered.debit = processed.daily.debit.filter(d=>inRange(d.date));
      processed.filtered.ph    = processed.daily.ph.filter(p=>inRange(p.date));

      // alertes (pour tableau)
      const alerts=[];
      processed.filtered.debit.forEach(d=>{ if(isDebitAlert(d.value)) alerts.push({date:d.date,type:'D√©bit',value:d.value,th:`‚â• ${DEBIT_THRESHOLD}`}); });
      processed.filtered.ph.forEach(p=>{ if(isPhAlert(p.value)) alerts.push({date:p.date,type:'pH',value:p.value,th:`‚â§ ${PH_MIN} ou ‚â• ${PH_MAX}`}); });
      processed.alerts = alerts.sort((a,b)=>dmyStrToUTCms(a.date)-dmyStrToUTCms(b.date));

      renderTables();
      updateExportState();
    }

    function renderTables(){
      const fmt=n=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});
      const dRows=processed.filtered.debit
        .sort((a,b)=>dmyStrToUTCms(a.date)-dmyStrToUTCms(b.date))
        .map(d=>`<tr class="${isDebitAlert(d.value)?'alert-row':''}">
          <td class="px-3 py-2 text-sm">${d.date}</td>
          <td class="px-3 py-2 text-sm font-medium">${fmt(d.value)}</td>
          <td class="px-3 py-2 text-sm"><span class="px-2 py-1 rounded text-xs ${isDebitAlert(d.value)?'ko-pill':'ok-pill'}">${isDebitAlert(d.value)?'‚ö†Ô∏è Alerte':'‚úÖ OK'}</span></td>
        </tr>`).join('');
      document.getElementById('debitTable').innerHTML=dRows || '<tr><td class="px-3 py-2 text-sm" colspan="3">Aucune donn√©e.</td></tr>';

      const pRows=processed.filtered.ph
        .sort((a,b)=>dmyStrToUTCms(a.date)-dmyStrToUTCms(b.date))
        .map(p=>`<tr class="${isPhAlert(p.value)?'alert-row':''}">
          <td class="px-3 py-2 text-sm">${p.date}</td>
          <td class="px-3 py-2 text-sm font-medium">${fmt(p.value)}</td>
          <td class="px-3 py-2 text-sm"><span class="px-2 py-1 rounded text-xs ${isPhAlert(p.value)?'ko-pill':'ok-pill'}">${isPhAlert(p.value)?'‚ö†Ô∏è Alerte':'‚úÖ OK'}</span></td>
        </tr>`).join('');
      document.getElementById('phTable').innerHTML=pRows || '<tr><td class="px-3 py-2 text-sm" colspan="3">Aucune donn√©e.</td></tr>';
    }

    // ---------------------- EXPORT AVEC MOD√àLE (MFC + fallback) ----------------------
    async function exportWithTemplate(){
      try{
        if(!templateArrayBuffer){ alert('Mod√®le non charg√©.'); return; }
        if(!processed.filtered.debit.length && !processed.filtered.ph.length){ alert('Aucune donn√©e filtr√©e √† exporter.'); return; }

        const wb = new ExcelJS.Workbook();
        await wb.xlsx.load(templateArrayBuffer);
        let ws = wb.getWorksheet('suivi des d√©bits et du pH') || wb.worksheets[0];

        // 1) reset valeurs/couleurs pr√©c√©dentes
        const zones = [
          {cols:['C','D'], from:14, to:44},   // Jan
          {cols:['H','I'], from:14, to:41},   // F√©v
          {cols:['M','N'], from:14, to:44},   // Mar
          {cols:['C','D'], from:50, to:79},   // Avr
          {cols:['H','I'], from:50, to:80},   // Mai
          {cols:['M','N'], from:50, to:79},   // Juin
          {cols:['C','D'], from:86, to:116},  // Juil
          {cols:['H','I'], from:86, to:116},  // Ao√ªt
          {cols:['M','N'], from:86, to:115}   // Sept
        ];
        zones.forEach(z=>{
          for(let r=z.from;r<=z.to;r++){
            z.cols.forEach(c=>{
              const cell=ws.getCell(`${c}${r}`);
              cell.value=null; cell.fill=null; cell.numFmt=undefined;
            });
          }
        });

        // 2) √©crire valeurs aux adresses exactes
        const mapD=new Map(processed.filtered.debit.map(d=>[d.date,d]));
        const mapP=new Map(processed.filtered.ph.map(p=>[p.date,p]));
        const allDates=new Set([...mapD.keys(),...mapP.keys()]);
        const sorted=Array.from(allDates).map(d=>({dStr:d, t:dmyStrToUTCms(d)})).filter(x=>x.t!=null).sort((a,b)=>a.t-b.t);

        sorted.forEach(o=>{
          const dt=new Date(o.t); if(dt.getUTCFullYear()!==2025) return;
          const m=dt.getUTCMonth(); const cfg=MONTH_MAP_2025[m]; if(!cfg) return;
          const day=dt.getUTCDate(); const row=cfg.startRow + (day-1);
          if(row<cfg.startRow || row>cfg.endRow) return;

          const dRec=mapD.get(o.dStr), pRec=mapP.get(o.dStr);
          const dCell=ws.getCell(`${cfg.debitCol}${row}`);
          const pCell=ws.getCell(`${cfg.phCol}${row}`);

          if(dRec){
            const v=Number(dRec.value);
            dCell.value = isFinite(v)?v:null;
            if(isFinite(v)) dCell.numFmt=NUM_FMT;
          } else { dCell.value=null; }

          if(pRec){
            const v=Number(pRec.value);
            pCell.value = isFinite(v)?v:null;
            if(isFinite(v)) pCell.numFmt=NUM_FMT;
          } else { pCell.value=null; }
        });

        // 3) essayer d'ajouter la MFC ; si √©chec ‚Üí fallback couleur directe
        const debitRefs = ['C14:C44','H14:H41','M14:M44','C50:C79','H50:H80','M50:M79','C86:C116','H86:H116','M86:M115'];
        const phRefs    = ['D14:D44','I14:I41','N14:N44','D50:D79','I50:I80','N50:N79','D86:D116','I86:I116','N86:N115'];

        let mfcOk = false;
        try{
          // purge anciennes MFC si pr√©sentes
          if (ws.model && Array.isArray(ws.model.conditionalFormattings)) ws.model.conditionalFormattings = [];
          // styles
          const RED  = { fill:{ type:'pattern', pattern:'solid', fgColor:{argb:'FFFF0000'}, bgColor:{argb:'FFFF0000'} } };
          const GREEN= { fill:{ type:'pattern', pattern:'solid', fgColor:{argb:'FF00B050'}, bgColor:{argb:'FF00B050'} } };

          // d√©bit
          debitRefs.forEach(ref=>{
            ws.addConditionalFormatting({
              ref,
              rules: [
                { type:'cellIs', operator:'greaterThanOrEqual', formulae:[String(DEBIT_THRESHOLD)], style: RED  },
                { type:'cellIs', operator:'lessThan',            formulae:[String(DEBIT_THRESHOLD)], style: GREEN}
              ]
            });
          });
          // pH
          phRefs.forEach(ref=>{
            const baseCol = ref.split(':')[0].replace(/\d+/g,''); // ex: 'D'
            ws.addConditionalFormatting({ ref, rules:[{ type:'cellIs', operator:'lessThanOrEqual', formulae:[String(PH_MIN)], style: RED }]});
            ws.addConditionalFormatting({ ref, rules:[{ type:'cellIs', operator:'greaterThanOrEqual', formulae:[String(PH_MAX)], style: RED }]});
            ws.addConditionalFormatting({ ref, rules:[{ type:'expression', formulae:[`AND(${baseCol}1>${PH_MIN},${baseCol}1<${PH_MAX})`.replace(/1$/, '')], style: GREEN }]});
            // Remarque: Excel ignore l'index de ligne dans l'expression et applique la logique par cellule.
          });

          mfcOk = true;
        }catch(e){
          console.warn('MFC indisponible, fallback couleurs directes.', e);
          mfcOk = false;
        }

        if(!mfcOk){
          // Fallback : recolorer en dur selon seuils (garanti)
          sorted.forEach(o=>{
            const dt=new Date(o.t); if(dt.getUTCFullYear()!==2025) return;
            const m=dt.getUTCMonth(); const cfg=MONTH_MAP_2025[m]; if(!cfg) return;
            const row=cfg.startRow + (dt.getUTCDate()-1);
            const dCell=ws.getCell(`${cfg.debitCol}${row}`);
            const pCell=ws.getCell(`${cfg.phCol}${row}`);

            if(dCell.value!=null && dCell.value!==''){
              const v=Number(dCell.value);
              dCell.fill=null; colorize(dCell, isFinite(v)?isDebitAlert(v):null);
            }
            if(pCell.value!=null && pCell.value!==''){
              const v=Number(pCell.value);
              pCell.fill=null; colorize(pCell, isFinite(v)?isPhAlert(v):null);
            }
          });
        }

        const buf=await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),'export_dep_ph_modele.xlsx');
        showBanner('ok', mfcOk ? 'Export OK ‚úî (couleurs via MFC).' : 'Export OK ‚úî (couleurs appliqu√©es en fallback).');
      }catch(err){
        console.error(err);
        showBanner('err','‚ùå Export √©chou√©. Ouvrez la console pour le d√©tail. V√©rifiez surtout que la page est servie en <b>http://</b> pour que le mod√®le soit bien charg√©.');
      }
    }
  </script>
</body>
</html>
