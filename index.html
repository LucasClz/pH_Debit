<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Analyseur Débit & pH — Modèle intégré</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Librairies -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    .upload-zone{border:2px dashed #d1d5db;transition:all .3s ease}
    .upload-zone:hover{border-color:#3b82f6;background:#f8fafc}
    .upload-zone.dragover{border-color:#2563eb;background:#eff6ff}
    .table-header{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    .alert-row{background:#fef2f2!important;border-left:4px solid #ef4444}
    .nav-tab{transition:all .3s ease}
    .nav-tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">📊 Analyseur Débit & pH</h1>
      <p class="text-gray-600 text-lg">Feuille Excel <b>reconstituée en code</b> (aucun modèle externe)</p>
    </header>

    <main class="max-w-6xl mx-auto">
      <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">📁 Importation</h2>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Débit -->
          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-3">💧 Fichier Débit (dernière valeur/jour)</h3>
            <div id="uploadZoneDebit" class="upload-zone rounded-lg p-6 text-center cursor-pointer">
              <p class="text-sm text-gray-600">Déposez ou cliquez pour choisir le fichier Débit</p>
              <p class="text-xs text-gray-400 mt-1">Seuil d'alerte Débit : ≥ 220</p>
            </div>
            <input type="file" id="fileInputDebit" accept=".xlsx,.xls,.csv" class="hidden">
            <div id="fileInfoDebit" class="mt-3 hidden">
              <div class="flex items-center p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                <span id="fileNameDebit" class="text-blue-800 font-medium"></span>
                <span id="fileSizeDebit" class="text-blue-600 ml-2"></span>
              </div>
            </div>
          </div>

          <!-- pH -->
          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-3">🧪 Fichier pH (moyenne/jour)</h3>
            <div id="uploadZonePh" class="upload-zone rounded-lg p-6 text-center cursor-pointer">
              <p class="text-sm text-gray-600">Déposez ou cliquez pour choisir le fichier pH</p>
              <p class="text-xs text-gray-400 mt-1">Seuils pH : ≤ 5.5 ou ≥ 8.5</p>
            </div>
            <input type="file" id="fileInputPh" accept=".xlsx,.xls,.csv" class="hidden">
            <div id="fileInfoPh" class="mt-3 hidden">
              <div class="flex items-center p-2 bg-green-50 border border-green-200 rounded-lg text-sm">
                <span id="fileNamePh" class="text-green-800 font-medium"></span>
                <span id="fileSizePh" class="text-green-600 ml-2"></span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6 text-center">
          <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg font-medium transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            🔍 Analyser
          </button>
        </div>
      </section>

      <section id="resultsSection" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <div class="flex flex-wrap gap-3 justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">📤 Exports</h2>
            <div class="flex flex-wrap gap-2">
              <button id="exportEmbeddedBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                📥 Excel (mise en page intégrée)
              </button>
              <button id="exportFallbackBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium">
                📥 Excel (tableau simple)
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold text-blue-600 mb-3">💧 Débit (dernière valeur/jour)</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                  <thead class="table-header text-white">
                    <tr><th class="px-4 py-2 text-xs font-medium uppercase">Date</th><th class="px-4 py-2 text-xs font-medium uppercase">Valeur</th><th class="px-4 py-2 text-xs font-medium uppercase">État</th></tr>
                  </thead>
                  <tbody id="debitTable" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-green-600 mb-3">🧪 pH (moyenne/jour)</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                  <thead class="table-header text-white">
                    <tr><th class="px-4 py-2 text-xs font-medium uppercase">Date</th><th class="px-4 py-2 text-xs font-medium uppercase">Moyenne</th><th class="px-4 py-2 text-xs font-medium uppercase">État</th></tr>
                  </thead>
                  <tbody id="phTable" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <script>
    // =================== ÉTAT & CONSTANTES ===================
    let debitData = [], phData = [];
    let processedData = { daily:{debit:[], ph:[]} };

    const DEBIT_THRESHOLD = 220;
    const PH_MIN = 5.5, PH_MAX = 8.5;

    // Couleurs (AARRGGBB)
    const FILL_RED   = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFFF0000' } }; // rouge
    const FILL_GREEN = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF00B050' } }; // vert Excel
    const NUM_FMT    = '0.00';

    // Mapping EXACT 2025 (tes coordonnées)
    const MONTH_MAP_2025 = {
      0: { label:'JANVIER',   jourCol:'B', debitCol:'C', phCol:'D', startRow:14, endRow:44 }, // 31
      1: { label:'FÉVRIER',   jourCol:'G', debitCol:'H', phCol:'I', startRow:14, endRow:41 }, // 28
      2: { label:'MARS',      jourCol:'L', debitCol:'M', phCol:'N', startRow:14, endRow:44 }, // 31
      3: { label:'AVRIL',     jourCol:'B', debitCol:'C', phCol:'D', startRow:50, endRow:79 }, // 30
      4: { label:'MAI',       jourCol:'G', debitCol:'H', phCol:'I', startRow:50, endRow:80 }, // 31
      5: { label:'JUIN',      jourCol:'L', debitCol:'M', phCol:'N', startRow:50, endRow:79 }, // 30
      6: { label:'JUILLET',   jourCol:'B', debitCol:'C', phCol:'D', startRow:86, endRow:116}, // 31
      7: { label:'AOÛT',      jourCol:'G', debitCol:'H', phCol:'I', startRow:86, endRow:116}, // 31
      8: { label:'SEPTEMBRE', jourCol:'L', debitCol:'M', phCol:'N', startRow:86, endRow:115}  // 30
    };

    function isDebitAlert(v){ return typeof v === 'number' && isFinite(v) && v >= DEBIT_THRESHOLD; }
    function isPhAlert(v){ return typeof v === 'number' && isFinite(v) && (v <= PH_MIN || v >= PH_MAX); }
    function colorize(cell, alert){
      if (alert === null) { cell.fill = null; return; }
      cell.fill = alert ? FILL_RED : FILL_GREEN;
    }

    // =================== INIT UI ===================
    window.addEventListener('load', ()=>{
      setupFileUpload('Debit', d=>{debitData=d; checkReady();});
      setupFileUpload('Ph',    d=>{phData=d;   checkReady();});

      document.getElementById('analyzeBtn').addEventListener('click', analyze);
      document.getElementById('exportEmbeddedBtn').addEventListener('click', exportExcelEmbeddedLayout);
      document.getElementById('exportFallbackBtn').addEventListener('click', exportExcelFallback);
    });

    function checkReady(){
      const ready = debitData.length && phData.length;
      document.getElementById('analyzeBtn').disabled = !ready;
    }

    // =================== UPLOADS ===================
    function setupFileUpload(type, callback){
      const uploadZone=document.getElementById(`uploadZone${type}`);
      const fileInput=document.getElementById(`fileInput${type}`);
      const fileInfo=document.getElementById(`fileInfo${type}`);
      const fileNameEl=document.getElementById(`fileName${type}`);
      const fileSizeEl=document.getElementById(`fileSize${type}`);

      uploadZone.addEventListener('click',()=>fileInput.click());
      uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover');});
      uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
      uploadZone.addEventListener('drop',e=>{
        e.preventDefault(); uploadZone.classList.remove('dragover');
        if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener('change',e=>{
        if(e.target.files.length) handleFile(e.target.files[0]);
      });

      function handleFile(file){
        fileNameEl.textContent=file.name;
        fileSizeEl.textContent=`(${(file.size/1024/1024).toFixed(2)} MB)`;
        fileInfo.classList.remove('hidden');
        const reader=new FileReader();
        reader.onload=(ev)=>{
          try{
            let data;
            if (file.name.toLowerCase().endsWith('.csv')){
              const csv=ev.target.result;
              const lines=csv.split(/\r?\n/).filter(l=>l.trim().length>0);
              const sep=detectSep(lines[0]);
              data=lines.map(line=>line.split(sep).map(c=>c.trim()));
            } else {
              const wb=XLSX.read(ev.target.result,{type:'array'});
              const ws=wb.Sheets[wb.SheetNames[0]];
              data=XLSX.utils.sheet_to_json(ws,{header:1});
            }
            const clean=(data||[]).filter(r=>r&&r.length>1&&r[0]&&r[1]);
            callback(clean);
          }catch(err){ console.error(err); alert(`Erreur lors du traitement du fichier ${type}`); }
        };
        if (file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file); else reader.readAsArrayBuffer(file);
      }
    }
    function detectSep(headerLine){
      const sc=(headerLine.match(/;/g)||[]).length, cc=(headerLine.match(/,/g)||[]).length; return sc>=cc?';':',';
    }

    // =================== DATES & PARSING ===================
    function parseInputDateUTC(s){ const m=String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return null; return Date.UTC(+m[1],+m[2]-1,+m[3]);}
    function parseDMYtoUTC(s){ const m=String(s||'').match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})$/); if(!m) return null; let y=+m[3]; if(y<100) y+=2000; return Date.UTC(y,+m[2]-1,+m[1]);}
    function parseExcelSerialUTC(s){ const txt=String(s||'').trim(); if(!/^\d{1,5}(\.\d+)?$/.test(txt)) return null; const serial=Math.floor(+txt); const epoch=Date.UTC(1899,11,30); return epoch+serial*86400000;}
    function parseAnyToUTC(s){ if(s===null||s===undefined||s==='') return null; return parseExcelSerialUTC(s)??parseDMYtoUTC(s)??parseInputDateUTC(s);}
    function dmyStrToUTCms(dmy){ let t=parseDMYtoUTC(dmy); if(t!==null) return t; return parseAnyToUTC(dmy); }
    function parseDateLoose(dateStr){
      const utc=parseAnyToUTC(dateStr); if(utc!==null) return new Date(utc);
      const parts=String(dateStr).trim().split(' '); const [d,m,y]=parts[0].split('/'); let H=0,M=0,S=0; if(parts[1]) [H,M,S]=parts[1].split(':').map(v=>parseInt(v||0,10));
      return new Date(Number(y),Number(m)-1,Number(d),H||0,M||0,S||0);
    }
    function formatDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }

    function analyze(){
      processedData.daily.debit = processDebitData(debitData);
      processedData.daily.ph    = processPhData(phData);
      renderTables();
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    function processDebitData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v)) return;
        const d=parseDateLoose(dateStr);
        const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push({time:d,value:v});
      });
      return Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=perDay[k].sort((a,b)=>a.time-b.time); const last=arr[arr.length-1].value;
        return {date:k, value:last, isAlert:isDebitAlert(last), count:arr.length};
      });
    }

    function processPhData(data){
      const perDay={};
      data.forEach((row,i)=>{ if(i===0) return;
        const dateStr=String(row[0]).trim();
        const raw = (row[1]!==undefined&&row[1]!==null) ? String(row[1]).replace(',','.') : '';
        const v = Number(raw);
        if(!dateStr || !isFinite(v) || v===0) return;
        const d=parseDateLoose(dateStr); const key=formatDate(d);
        (perDay[key]=perDay[key]||[]).push(v);
      });
      return Object.keys(perDay).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b)).map(k=>{
        const arr=(perDay[k]||[]).filter(v=>isFinite(v)&&v!==0);
        if(!arr.length) return null;
        const avg=arr.reduce((a,b)=>a+b,0)/arr.length;
        return {date:k, value:avg, isAlert:isPhAlert(avg), count:arr.length};
      }).filter(Boolean);
    }

    function renderTables(){
      const fmt=n=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});

      const dRows=processedData.daily.debit.map(d=>`
        <tr class="${d.isAlert?'alert-row':''}">
          <td class="px-4 py-2 text-sm">${d.date}</td>
          <td class="px-4 py-2 text-sm font-medium">${fmt(d.value)}</td>
          <td class="px-4 py-2 text-sm">${d.isAlert?'<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">⚠️ Alerte</span>':'<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">✅ OK</span>'}</td>
        </tr>`).join('');
      document.getElementById('debitTable').innerHTML=dRows || '<tr><td class="px-4 py-2 text-sm" colspan="3">Aucune donnée.</td></tr>';

      const pRows=processedData.daily.ph.map(p=>`
        <tr class="${p.isAlert?'alert-row':''}">
          <td class="px-4 py-2 text-sm">${p.date}</td>
          <td class="px-4 py-2 text-sm font-medium">${fmt(p.value)}</td>
          <td class="px-4 py-2 text-sm">${p.isAlert?'<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">⚠️ Alerte</span>':'<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">✅ OK</span>'}</td>
        </tr>`).join('');
      document.getElementById('phTable').innerHTML=pRows || '<tr><td class="px-4 py-2 text-sm" colspan="3">Aucune donnée.</td></tr>';
    }

    // =================== EXPORTS ===================
    async function exportExcelEmbeddedLayout(){
      if(!processedData.daily.debit.length && !processedData.daily.ph.length){
        alert('Analyse d’abord les données.'); return;
      }

      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet('suivi des débits et du pH');

      // (Optionnel) un peu de mise en page globale
      ws.properties.defaultRowHeight = 16;
      // définit des largeurs pour B..N pour y voir clair
      const widths = { B:12, C:12, D:12, G:12, H:12, I:12, L:12, M:12, N:12 };
      Object.entries(widths).forEach(([col,w])=>{ ws.getColumn(col).width = w; });

      // Écrire les dates/valeurs aux adresses EXACTES définies
      const mapD=new Map(processedData.daily.debit.map(d=>[d.date,d]));
      const mapP=new Map(processedData.daily.ph.map(d=>[d.date,d]));
      const allDates = new Set([...mapD.keys(), ...mapP.keys()]);
      const sorted = Array.from(allDates).map(d=>({dStr:d, t:dmyStrToUTCms(d)})).filter(o=>o.t!=null).sort((a,b)=>a.t-b.t);

      sorted.forEach(o=>{
        const dt = new Date(o.t);
        if (dt.getUTCFullYear() !== 2025) return; // on remplit uniquement 2025
        const m = dt.getUTCMonth(); // 0..11
        const cfg = MONTH_MAP_2025[m];
        if (!cfg) return; // Oct–Déc non mappés ici
        const day = dt.getUTCDate();
        const row = cfg.startRow + (day - 1);
        if (row < cfg.startRow || row > cfg.endRow) return; // hors plage du mois

        // Jour (écrit à 23:59:59 UTC pour éviter l'heure locale dans Excel)
        const jourCell = ws.getCell(`${cfg.jourCol}${row}`);
        jourCell.value = new Date(Date.UTC(2025, m, day, 23,59,59));
        jourCell.numFmt = 'dd/mm/yyyy';

        // Débit
        const dRec = mapD.get(o.dStr);
        const debCell = ws.getCell(`${cfg.debitCol}${row}`);
        if (dRec){
          const v = Number(dRec.value);
          debCell.value = isFinite(v) ? v : null;
          debCell.numFmt = NUM_FMT;
          colorize(debCell, isFinite(v) ? isDebitAlert(v) : null);
        } else {
          debCell.value = null; debCell.fill = null;
        }

        // pH
        const pRec = mapP.get(o.dStr);
        const phCell = ws.getCell(`${cfg.phCol}${row}`);
        if (pRec){
          const v = Number(pRec.value);
          phCell.value = isFinite(v) ? v : null;
          phCell.numFmt = NUM_FMT;
          colorize(phCell, isFinite(v) ? isPhAlert(v) : null);
        } else {
          phCell.value = null; phCell.fill = null;
        }
      });

      const buf=await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),'export_modele_integre.xlsx');
    }

    async function exportExcelFallback(){
      if(!processedData.daily.debit.length && !processedData.daily.ph.length){
        alert('Analyse d’abord les données.'); return;
      }
      const wb=new ExcelJS.Workbook();
      const ws=wb.addWorksheet('suivi des débits et du pH (simple)');

      const headerFill={type:'pattern',pattern:'solid',fgColor:{argb:'FF1D4ED8'}};
      const headerFont={color:{argb:'FFFFFFFF'},bold:true};
      const borderThin={style:'thin',color:{argb:'FFCCCCCC'}};

      ws.addRow(['Date','Débit (dernière valeur)','pH (moyenne)','Statut Débit','Statut pH']);
      ws.getRow(1).eachCell(c=>{ c.fill=headerFill; c.font=headerFont; c.border={top:borderThin,left:borderThin,bottom:borderThin,right:borderThin}; c.alignment={vertical:'middle',horizontal:'center'}; });

      const mapD=new Map(processedData.daily.debit.map(d=>[d.date,d]));
      const mapP=new Map(processedData.daily.ph.map(d=>[d.date,d]));
      const all=new Set([...mapD.keys(),...mapP.keys()]);
      const sorted=Array.from(all).sort((a,b)=>dmyStrToUTCms(a)-dmyStrToUTCms(b));

      sorted.forEach(ds=>{
        const dRec=mapD.get(ds), pRec=mapP.get(ds);
        const dv = dRec?Number(dRec.value):null;
        const pv = pRec?Number(pRec.value):null;
        const r=ws.addRow([ds, dv, pv, dRec?(isDebitAlert(dv)?'ALERTE':'OK'):'', pRec?(isPhAlert(pv)?'ALERTE':'OK'):'' ]);
        if(dRec){ colorize(r.getCell(2), isFinite(dv)?isDebitAlert(dv):null); r.getCell(2).numFmt=NUM_FMT; }
        if(pRec){ colorize(r.getCell(3), isFinite(pv)?isPhAlert(pv):null); r.getCell(3).numFmt=NUM_FMT; }
        r.eachCell(c=>{ c.border={top:borderThin,left:borderThin,bottom:borderThin,right:borderThin}; });
      });

      ws.columns=[{width:14},{width:22},{width:16},{width:14},{width:12}];

      const buf=await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),'export_simple.xlsx');
    }
  </script>
</body>
</html>
